<!DOCTYPE html>
<html>
<head>
    <title>Food Ordering Website</title>

    <link rel="stylesheet" type="text/css" href="style.css">

    <script src="https://code.jquery.com/jquery-3.2.0.js"></script>
</head>

<body>
    <!-- Modal -->
    <div class="modalContainer">
      <div class="modal-header">
          <span class="close">&times;</span>
          <h2>Details</h2>
      </div>
      <div class="modal-body">
        <div id = "ingredients"></div>
        <div id = "price"></div>
      </div>
      <div class="modal-footer">
      </div>
    </div>

    <!-- Navbar -->
    <header>
        <ul>
            <a href="index.html">
                <li id="home">Home</li>
            </a>
            <a href="cart.html">
                <li id="cart">Cart (0)</li>
            </a>
            <a href="login.html">
                <li id="login">Login/Register</li>
            </a>
        </ul>
    </header>

    <!-- Title -->
    <div>
        <h1>Menu</h1>
    </div>

    <!-- Menu -->
    <div class="menu-container">
    </div>

    <!-- Footer -->
    <footer>
        <p>Contact</p>
    </footer>


    <!-- Javascript -->
    <script>

        $.ajax({
          // url: "http://thiman.me:1337/menu/kody",
          url: "http://localhost:3000/menu",
          type: "GET",
          success:(function(e){
            menu = e;

            // Select menu Container
            var menuContainer = $('.menu-container');

            // Loop through menu in database
            for (var i = 0; i < menu.length; i++){

                var item = menu[i];

                // Create menu item with title and menu id
                var container = $('<div/>').addClass('menu-item');

                var title = $('<div/>').addClass('title').html(item.title);
                var itemEle = $('<div/>')
                              .addClass('item')
                              .attr("id", `menu-${i}`);

                // insert image
                var image = $('<img/>').attr("src", item.img).attr("id", i);
                itemEle.append(image);

                var button = $('<button/>').addClass("button").addClass("button" + i).html("Add to Cart");

                container.append(title).append(itemEle).append(button.clone());

                menuContainer.append(container);
            }

            // Create modal
            var modalContainer = $('.modalContainer');

            $('.menu-item .item img').on('click', function(e){
              // get index of item
              var index = parseInt($(this).attr("id"));
              var item = menu[index];

              // console.log(item.ingredients);
              // console.log(item.price);
              $("#ingredients").html(`Ingredients: ${item.ingredients}`);
              $("#price").html(`Price: \$${item.price}`);

              modalContainer.css("display","block");
            })

            // post to cart if not exists
            $.ajax({
              url: "http://thiman.me:1337/cart/kody",
              type: "GET",
              success:(function(e){
                  cart = e;
                  // check if menu item exists in cart
                  for (var i = 0; i < menu.length; i++){
                    var exists = 0;
                    for (var j = 0; j < cart.length; j++){
                      if (menu[i]["_id"] === cart[j]["_id"]){
                        //console.log(menu[i]["_id"])
                        //console.log(cart[j]["_id"])
                        exists++;
                      }
                    }
                    if (exists === 0){
                      //console.log(exists)
                      $.ajax({
                        url: "http://thiman.me:1337/cart/kody",
                        type: "POST",
                        data: {
                                _id: menu[i]["_id"],
                                title: menu[i]["title"],
                                img: menu[i]["img"],
                                price: menu[i]["price"],
                                ingredients: menu[i]["ingredients"]
                              }
                      });
                    }
                  }
              })
            })
          })
        });

        // maintain cart quantity
        $.ajax({
          url: "http://thiman.me:1337/cart/kody",
          type: "GET",
          success: (function(e){
            menu = e;
            var c = 0;
            for (var i = 0; i < menu.length; i++){
              var item = menu[i];
              c += parseInt(item["quantity"]);
            }

            cart.innerHTML = "Cart (" + c + ")";
          })
        });


        // EVENT DELEGATION

        // $('.modalContainer').on('click', window, function(e){
        //   $('.modalContainer').css("display","none");
        // });

        // close modal when close button
        $('.modalContainer').on('click', '.close', function(e){
          $('.modalContainer').css("display","none");
        });

        // add to cart button click event
        $('.menu-container').on('click', ".button", function(e){
          var button = $(this);

          var cartNo = $('#cart').html();
          var length = cartNo.length - 1;
          var cartNumber = parseInt(cartNo.slice(6, length));

          cartNumber++;

          $("#cart").html("Cart (" + cartNumber + ")");

          var str = $(this).attr("class");
          var index = parseInt(str.slice(13, str.length));

          var link = "http://thiman.me:1337/cart/kody/" + menu[index]["_id"];

          var quantity = ++menu[index]["quantity"];

          // update quantity of clicked item in cart
          $.ajax({
            url: link,
            type:"PATCH",
            data:{"quantity":quantity}
          });
        });


    </script>

</body>
</html>
