<!DOCTYPE html>
<html>
  <head>
    <% include head.ejs %>

    <link rel='stylesheet' href="checkoutstyle.css" />
  </head>

  <body>
    <!-- header -->
    <% include header.ejs %>

    <div id="checkout">

      <h3>Select Form of Payment</h3>
      <form name="payment">
        <input type="radio" name="type" value="cc"> Credit / Debit Card
        <input type="radio" name="type" value="ca"> Cash
      </form>

      <p>Credit / Debit Card Number</p>
      <p><input type="credit card" style="width:376px"></p>

      <table>
        <tr>
          <td>
            <p>Expiration date</p>
            <p><input type="month"></p>
          </td>
          <td>
            <p>CV number</p>
            <p><input maxlength="3" type="cv"></p>
          </td>
        </tr>
      </table>

      <p>Name</p>
      <table>
        <tr>
          <td>
            <p><input name="first" type="text" placeholder="First Name" onfocus="this.placeholder = ''" onblur="this.placeholder = 'First Name'" /></p>
          </td>
          <td>
            <p><input name="last" type="text" placeholder="Last Name" onfocus="this.placeholder = ''" onblur="this.placeholder = 'Last Name'" /></p>
          </td>
        </tr>
      </table>

      <p>Phone Number</p>
      <p><input name="phone" type="text" placeholder='Phone Number' onfocus="this.placeholder = ''" onblur="this.placeholder = 'Phone Number'" /></p>

      <p>Billing Address</p>
      <p><input type="bstreet" placeholder="Street" onfocus="this.placeholder = ''" onblur="this.placeholder = 'Street'" style="width:531px"/></p>
      <p><input type="bcity" placeholder="City" onfocus="this.placeholder = ''" onblur="this.placeholder = 'City'" />
        <input type="bstate" maxlength="2" placeholder="State" onfocus="this.placeholder = ''" onblur="this.placeholder = 'State'" />
        <input type="bzip"  maxlength="5" placeholder="Zipcode" onfocus="this.placeholder = ''" onblur="this.placeholder = 'Zipcode'" /></p>

      </br>
      </br>

      <p>Delivery Address</p>
      <p><input type="dstreet" placeholder="Street" onfocus="this.placeholder = ''" onblur="this.placeholder = 'Street'" style="width:531px"/></p>
      <p><input type="dcity" placeholder="City" onfocus="this.placeholder = ''" onblur="this.placeholder = 'City'" />
        <input type="dstate" maxlength="2" placeholder="State" onfocus="this.placeholder = ''" onblur="this.placeholder = 'State'" />
        <input type="dzip"  maxlength="5" placeholder="Zipcode" onfocus="this.placeholder = ''" onblur="this.placeholder = 'Zipcode'" /></p>


      <p>Delivery Comments</p>
      <p><textarea rows="4" cols="50" style="margin: 0px; width: 527px; height: 152px;"></textarea></p>

    </div>

    <div class="button">
      <button>
        Pay
      </button>
    </div>



  <script>


    $('body').on('click','.button', function(e){

      var payment_type = document.forms["payment"]["type"].value;
      var credit_card = document.querySelector('input[type="credit card"]').value;
      var exp = document.querySelector('input[type="month"]').value;
      var cv = document.querySelector('input[type="cv"]').value;
      var first = document.querySelector('input[name="first"]').value;
      var last = document.querySelector('input[name="last"]').value;
      var phone = document.querySelector('input[name="phone"]').value;

      var bstreet = document.querySelector('input[type="bstreet"]').value;
      var bcity = document.querySelector('input[type="bcity"]').value;
      var bstate = document.querySelector('input[type="bstate"]').value;
      var bzip = document.querySelector('input[type="bzip"]').value;

      var dstreet = document.querySelector('input[type="dstreet"]').value;
      var dcity = document.querySelector('input[type="dcity"]').value;
      var dstate = document.querySelector('input[type="dstate"]').value;
      var dzip = document.querySelector('input[type="dzip"]').value;

      var comments = document.querySelector('textarea').value;

      if (payment_type == "") {
          alert("Select payment type");
          return false;
      }
      if (payment_type==="cc"){
        if (!Number.isInteger(parseInt(credit_card)) || !(credit_card.length == 16 || credit_card.length == 15)){
          alert("invalid credit_card");
          return false;
        }
        if (!Number.isInteger(parseInt(cv)) || !(cv.length == 3)){
          alert("invalid cv number");
          return false;
        }
        if (exp==""){
          alert("invalid expiration date");
          return false;
        }
        if (bstreet=="" || bcity == "" || bstate == "" || bzip == ""){
          alert("invalid billing address");
          return false;
        }
      }
      if (first == "" || last == ""){
        alert("please enter first and last name");
        return false;
      }
      if (dstreet=="" || dcity == "" || dstate == "" || dzip == ""){
        alert("invalid delivery address");
        return false;
      }
      else {

        var current = [];

        $.ajax({
          url: "http://localhost:3000/cart/users/",
          type: "GET",
          success: function(e){

              var wholecart = e;

              for(var j = 0; j < wholecart.length; j++){
                if (wholecart[j].userId === "<%= user._id%>"){
                    current = wholecart[j].items;
                }
              }
              console.log(current);

              $.ajax({
                url:"http://localhost:3000/checkout/",
                type:"POST",
                data: {cart: current,
                       fname: first,
                       lname: last,
                       phone: phone,
                       street: dstreet,
                       city: dcity,
                       state: dstate,
                       zipcode: dzip
                     },
                success: function(e){
                  console.log(e);
                }

              })
          }
        })
      window.location.replace('/receipt')
      }
    })


  </script>


  </body>
  </html>
